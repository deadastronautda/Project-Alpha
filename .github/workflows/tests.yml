name: Run Tests

on:
  push:
    branches: [ "main", "qa_dev" ]  # добавил твою ветку qa_dev, чтобы сразу проверялось
  pull_request:
    branches: [ "main", "qa_dev" ]

jobs:
  test:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # ← ВАЖНО: сначала ставим все зависимости
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-test.txt  # у тебя там pytest и всё нужное

      # ← КЛЮЧЕВОЙ ШАГ: делаем твой проект устанавливаемым пакетом
      - name: Install project in editable mode
        run: |
          pip install -e . 

      # ← Теперь тесты увидят твой код и перестанут падать на collection
      - name: Run tests with coverage
        run: |
          pytest --cov=app --cov-report=term-missing --cov-report=xml -vv

      # Опционально: загрузка отчёта покрытия в Codecov / Coveralls (если потом захочешь)
      # - name: Upload coverage reports
      #   uses: codecov/codecov-action@v4